<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>World Time USA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    h1 {
      font-size: 3em;
      margin-bottom: 10px;
    }
    #clock {
      font-size: 5em;
      font-weight: bold;
    }
  </style>
  <script>
    /************************************************************
     *         Multi-Ping Sync Variables & Functions            *
     ************************************************************/
    let offsetMs = 0; // final offset in ms (server time - local time)
    let clockTimer = null; // reference to our setInterval for the clock

    // Single "ping" to /sync. Returns an offset in ms (serverMidpoint - clientMidpoint),
    // or null if there's an error.
    async function singleSync() {
      try {
        // t0: client time before request
        const t0 = performance.now();
        const response = await fetch("/sync");
        const t1 = performance.now(); // client time after response

        if (!response.ok) {
          throw new Error(`Server responded with status ${response.status}`);
        }

        const data = await response.json();
        // data.time is an ISO string, e.g. "2025-01-22T14:15:16.789Z"
        const serverTimeMs = new Date(data.time).getTime();

        // Round-trip
        const roundTrip = t1 - t0;
        // Assume half the round-trip is one-way
        const oneWay = roundTrip / 2;

        // The server time at the midpoint is serverTimeMs + oneWay
        // Our local time at midpoint is (t0 + t1) / 2
        const serverMidpoint = serverTimeMs + oneWay;
        const clientMidpoint = (t0 + t1) / 2;

        return serverMidpoint - clientMidpoint; // offset
      } catch (err) {
        console.warn("singleSync error:", err);
        return null;
      }
    }

    // Multi-ping: do multiple singleSync calls, then pick the median offset.
    async function multiSyncTime(attempts = 5) {
      const offsets = [];
      for (let i = 0; i < attempts; i++) {
        const thisOffset = await singleSync();
        if (thisOffset !== null) offsets.push(thisOffset);
        // short pause between attempts (100ms)
        await new Promise(res => setTimeout(res, 100));
      }

      if (!offsets.length) {
        console.error("All sync attempts failed. No offset calculated.");
        return;
      }

      // Sort offsets
      offsets.sort((a, b) => a - b);
      // Median
      const mid = Math.floor(offsets.length / 2);

      if (offsets.length % 2 === 1) {
        offsetMs = offsets[mid];
      } else {
        offsetMs = (offsets[mid - 1] + offsets[mid]) / 2;
      }

      console.log(`Multi-sync offset: ${offsetMs.toFixed(2)} ms (from ${offsets.length} valid pings)`);
    }

    /************************************************************
     *                   Clock Display Logic                    *
     ************************************************************/

    function updateClock() {
      // localNow is the local system time in ms (UTC-based integer).
      const localNow = Date.now(); 
      // corrected time = localNow + offset
      const correctedUtcNow = localNow + offsetMs;

      // The Date constructor interprets numeric ms as "UTC-based epoch"
      // but displays using your *local time zone* by default.
      const dateObj = new Date(correctedUtcNow);

      // Format it as HH:MM:SS (24-hour)
      const hh = String(dateObj.getHours()).padStart(2, "0");
      const mm = String(dateObj.getMinutes()).padStart(2, "0");
      const ss = String(dateObj.getSeconds()).padStart(2, "0");

      document.getElementById("clock").textContent = `${hh}:${mm}:${ss}`;
    }

    /************************************************************
     *              Initialization on Page Load                 *
     ************************************************************/

    window.addEventListener("load", async () => {
      // Show "Loading..." or something so we don't display a zero-offset clock
      document.getElementById("clock").textContent = "Loading...";

      // 1. Perform a multi-ping sync right away (5 pings by default)
      await multiSyncTime(5);

      // 2. Now that offsetMs is set, start the clock updates
      updateClock(); // immediate update
      clockTimer = setInterval(updateClock, 1000);

      // 3. Re-sync every 10 minutes (adjust as needed)
      setInterval(() => multiSyncTime(5), 10 * 60 * 1000);
    });
  </script>
</head>
<body>
  <h1>World Time USA</h1>
  <div id="clock">--:--:--</div>
  <h2>Synchronized with Stratum 1 NTP Server</h2>
</body>
</html>
