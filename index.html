<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Time USA</title>
  <link rel="stylesheet" href="styles.css"> <!-- ✅ Properly linked CSS -->
  
  <script>
    let offset = 0; 
    let lastSyncTime = 0; 

    // ✅ List of major cities & their IANA time zones
    const cities = [
      { name: "Los Angeles", timeZone: "America/Los_Angeles" },
      { name: "New York", timeZone: "America/New_York" },
      { name: "London", timeZone: "Europe/London" },
      { name: "Paris", timeZone: "Europe/Paris" },
      { name: "Beijing", timeZone: "Asia/Shanghai" },
      { name: "Tokyo", timeZone: "Asia/Tokyo" }
    ];

    /************************************************************
     *  Multi-Ping Sync: Perform multiple pings & pick best offset
     ************************************************************/
    async function syncTime(pings = 5) {
        const offsets = [];
        document.getElementById("loading").textContent = "Syncing with NTP server...";

        for (let i = 0; i < pings; i++) {
            const offset = await singlePing();
            if (offset !== null) {
                offsets.push(offset);
            }
            await new Promise(res => setTimeout(res, 50)); // Short delay between pings
        }

        if (offsets.length === 0) {
            console.error("All pings failed! Offset not updated.");
            document.getElementById("loading").textContent = "Sync failed.";
            return;
        }

        // ✅ Pick the best offset (median is more stable)
        offsets.sort((a, b) => a - b);
        const mid = Math.floor(offsets.length / 2);
        offset = offsets.length % 2 === 1 ? offsets[mid] : (offsets[mid - 1] + offsets[mid]) / 2;

        lastSyncTime = Date.now();
        document.getElementById("loading").textContent = "Stratum 1 Disciplined";
        console.log(`Offsets collected: ${offsets.map(o => o.toFixed(2))} ms`);
    }

    /************************************************************
     *  Single Ping: Fetch time from /time & calculate offset
     ************************************************************/
    async function singlePing() {
        try {
            const requestStart = Date.now();
            const response = await fetch("/time");
            const data = await response.json();
            const requestEnd = Date.now();

            const serverUTC = new Date(data.utc_time).getTime();
            const roundTripTime = requestEnd - requestStart;
            const processingDelay = data.serverProcessingTime;
            const networkLatency = (roundTripTime - processingDelay) / 2;

            return serverUTC + networkLatency - Date.now(); // Return corrected offset
        } catch (error) {
            console.error("Failed to fetch NTP time:", error);
            return null;
        }
    }

    /************************************************************
     *  Smooth Real-Time Clock Update (Higher Accuracy)
     ************************************************************/
    function updateClock() {
        const now = new Date(Date.now() + offset);

        // ✅ Convert UTC to user's local time
        const localTimeString = now.toLocaleTimeString("en-US", { 
            hour: "2-digit", 
            minute: "2-digit", 
            second: "2-digit", 
            hour12: true 
        });

        document.getElementById("clock").innerText = localTimeString;

        // ✅ Update world city clocks every second (smooth animation)
        updateWorldClocks(now);

        // ✅ RequestAnimationFrame makes updates smooth
        requestAnimationFrame(updateClock);
    }

    /************************************************************
     *  Update World Clocks (Fixes Time Zones & DST)
     ************************************************************/
    function updateWorldClocks(nowUTC) {
        cities.forEach(city => {
            const cityTimeString = nowUTC.toLocaleTimeString("en-US", { 
                hour: "2-digit", 
                minute: "2-digit", 
                second: "2-digit",
                hour12: true,
                timeZone: city.timeZone // ✅ Adjust for DST
            });

            document.getElementById(city.name).innerText = cityTimeString;
        });
    }

    /************************************************************
     *  ✅ Update Date Display (User's Local Date)
     ************************************************************/
    function updateDate() {
        const now = new Date();
        
        // ✅ Format: "Friday, January 24, 2025"
        const formattedDate = now.toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
        });

        document.getElementById("date").textContent = formattedDate;
    }

    /************************************************************
     *  Continuous Sync: Re-sync every 2 minutes to avoid drift
     ************************************************************/
    setInterval(() => {
        const drift = Date.now() - lastSyncTime;
        if (drift > 120000) { // ✅ Re-sync if more than 2 minutes have passed
            syncTime();
        }
    }, 10000); // ✅ Check every 10 seconds

    /************************************************************
     *  Page Initialization
     ************************************************************/
    window.onload = async () => {
        await syncTime(5); // ✅ Perform 5 pings on startup
        updateClock(); // ✅ Start updating clock in real time
        updateDate();  // ✅ Display the formatted date
    };
</script>
</head>

<body>
  <h1>World Time USA</h1>
  <div id="clock">--:--:--</div>
  <p id="loading">Syncing with NTP server...</p>

  <!-- ✅ Date Display -->
  <div id="date"></div>

  <!-- ✅ City Time Blocks (Only One Set) -->
  <div class="city-container">
    <div class="city">Los Angeles<br><span id="Los Angeles">--:--:--</span></div>
    <div class="city">New York<br><span id="New York">--:--:--</span></div>
    <div class="city">London<br><span id="London">--:--:--</span></div>
    <div class="city">Paris<br><span id="Paris">--:--:--</span></div>
    <div class="city">Beijing<br><span id="Beijing">--:--:--</span></div>
    <div class="city">Tokyo<br><span id="Tokyo">--:--:--</span></div>
  </div>
</body>
</html>
