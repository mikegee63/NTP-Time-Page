<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Time USA</title>
  <link rel="stylesheet" href="styles.css"> <!-- âœ… Properly linked CSS -->
  
  <script>
    let offset = 0; 
    let lastSyncTime = 0; 

    // âœ… List of major cities & their IANA time zones
    const cities = [
      { name: "Los Angeles", timeZone: "America/Los_Angeles" },
      { name: "New York", timeZone: "America/New_York" },
      { name: "London", timeZone: "Europe/London" },
      { name: "Paris", timeZone: "Europe/Paris" },
      { name: "Beijing", timeZone: "Asia/Shanghai" },
      { name: "Tokyo", timeZone: "Asia/Tokyo" }
    ];

    /************************************************************
     *  Multi-Ping Sync: Perform multiple pings & pick best offset
     ************************************************************/
    async function syncTime(pings = 5) {
        const offsets = [];
        document.getElementById("loading").textContent = "Syncing with NTP server...";

        for (let i = 0; i < pings; i++) {
            const offset = await singlePing();
            if (offset !== null) {
                offsets.push(offset);
            }
            await new Promise(res => setTimeout(res, 50)); // Short delay between pings
        }

        if (offsets.length === 0) {
            console.error("All pings failed! Offset not updated.");
            document.getElementById("loading").textContent = "Sync failed.";
            return;
        }

        // âœ… Pick the best offset (median is more stable)
        offsets.sort((a, b) => a - b);
        const mid = Math.floor(offsets.length / 2);
        offset = offsets.length % 2 === 1 ? offsets[mid] : (offsets[mid - 1] + offsets[mid]) / 2;

        lastSyncTime = Date.now();
        document.getElementById("loading").textContent = "Stratum 1 Disciplined";
        console.log(`Offsets collected: ${offsets.map(o => o.toFixed(2))} ms`);
    }

    /************************************************************
     *  Single Ping: Fetch time from /time & calculate offset
     ************************************************************/
   async function syncTime() {
    try {
        const response = await fetch("/time");
        const data = await response.json();
        const serverTime = new Date(data.time).getTime();
        const clientTime = Date.now();
        offset = serverTime - clientTime;
        
        updateClock(); // âœ… Immediately update the clock after syncing

        document.getElementById("loading").textContent = "Stratum 1 Disciplined";
    } catch (error) {
        console.error("Failed to fetch NTP time:", error);
        document.getElementById("loading").textContent = "Sync failed.";
    }
}


    /************************************************************
     *  Smooth Real-Time Clock Update (Higher Accuracy)
     ************************************************************/
    function updateClock() {
    const now = new Date(Date.now() + offset);
    const hours = String(now.getHours()).padStart(2, "0");
    const minutes = String(now.getMinutes()).padStart(2, "0");
    const seconds = String(now.getSeconds()).padStart(2, "0");
    
    const clockElement = document.getElementById("clock");
    
    if (clockElement) {
        clockElement.innerText = `${hours}:${minutes}:${seconds}`;
    } else {
        console.error("Clock element NOT FOUND!");
    }
}


    /************************************************************
     *  Update World Clocks (Fixes Time Zones & DST)
     ************************************************************/
    function updateWorldClocks(nowUTC) {
        cities.forEach(city => {
            const cityTimeString = nowUTC.toLocaleTimeString("en-US", { 
                hour: "2-digit", 
                minute: "2-digit", 
                second: "2-digit",
                hour12: true,
                timeZone: city.timeZone // âœ… Adjust for DST
            });

            document.getElementById(city.name).innerText = cityTimeString;
        });
    }

    /************************************************************
     *  âœ… Update Date Display (User's Local Date)
     ************************************************************/
    function updateDate() {
        const now = new Date();
        
        // âœ… Format: "Friday, January 24, 2025"
        const formattedDate = now.toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
        });

        document.getElementById("date").textContent = formattedDate;
    }

    /************************************************************
     *  Continuous Sync: Re-sync every 2 minutes to avoid drift
     ************************************************************/
    setInterval(() => {
        const drift = Date.now() - lastSyncTime;
        if (drift > 120000) { // âœ… Re-sync if more than 2 minutes have passed
            syncTime();
        }
    }, 10000); // âœ… Check every 10 seconds

    /************************************************************
     *  Page Initialization
     ************************************************************/
    window.onload = async () => {
        await syncTime(5); // âœ… Perform 5 pings on startup
        updateClock(); // âœ… Start updating clock in real time
        updateDate();  // âœ… Display the formatted date
    };
    document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("clock").innerText = "Loading...";
    syncTime(); // ðŸ”¹ Fetch NTP time as soon as page loads
});

setInterval(updateClock, 1000);

</script>
</head>

<body>
  <h1>World Time USA</h1>
  <div id="clock">--:--:--</div>
  <p id="loading">Syncing with NTP server...</p>

  <!-- âœ… Date now positioned before city blocks -->
<!-- Date container spanning full width -->

   <!-- Wrapper for City Blocks & Date -->
<div class="city-wrapper">
    <div id="date"></div>

    <!-- City Time Blocks -->
    <div class="city-container">
        <div class="city">Los Angeles<br><span id="Los Angeles">--:--:--</span></div>
        <div class="city">New York<br><span id="New York">--:--:--</span></div>
        <div class="city">London<br><span id="London">--:--:--</span></div>
        <div class="city">Paris<br><span id="Paris">--:--:--</span></div>
        <div class="city">Beijing<br><span id="Beijing">--:--:--</span></div>
        <div class="city">Tokyo<br><span id="Tokyo">--:--:--</span></div>
    </div>
</div>



</body>
</html>
