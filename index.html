<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Time USA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    h1 {
      font-size: 3em;
      margin-bottom: 10px;
    }
    #clock {
      font-size: 5em;
      font-weight: bold;
    }
    #loading {
      font-size: 1.5em;
      margin-top: 10px;
    }
  </style>
  <script>
    let offset = 0; // Final offset in ms between server & client
    let lastSyncTime = 0; // Last sync time (for drift calculations)

    /************************************************************
     *  Multi-Ping Sync: Perform multiple pings & pick best offset
     ************************************************************/
    async function syncTime(pings = 5) {
        const offsets = [];
        document.getElementById("loading").textContent = "Syncing with NTP server...";

        for (let i = 0; i < pings; i++) {
            const offset = await singlePing();
            if (offset !== null) {
                offsets.push(offset);
            }
            await new Promise(res => setTimeout(res, 50)); // Short delay between pings
        }

        if (offsets.length === 0) {
            console.error("All pings failed! Offset not updated.");
            document.getElementById("loading").textContent = "Sync failed.";
            return;
        }

        // Pick the best offset (median is less affected by network spikes)
        offsets.sort((a, b) => a - b);
        const mid = Math.floor(offsets.length / 2);
        offset = offsets.length % 2 === 1 ? offsets[mid] : (offsets[mid - 1] + offsets[mid]) / 2;

        lastSyncTime = Date.now();
        document.getElementById("loading").textContent = "Sync complete.";
        console.log(`Offsets collected: ${offsets.map(o => o.toFixed(2))} ms`);
    }

    /************************************************************
     *  Single Ping: Fetch time from /time & calculate offset
     ************************************************************/
    async function singlePing() {
        try {
            const requestStart = Date.now();
            const response = await fetch("/time");
            const data = await response.json();
            const requestEnd = Date.now();

            const serverUTC = new Date(data.utc_time).getTime();
            const roundTripTime = requestEnd - requestStart;
            const processingDelay = data.serverProcessingTime;
            const networkLatency = (roundTripTime - processingDelay) / 2;

            return serverUTC + networkLatency - Date.now(); // Return corrected offset
        } catch (error) {
            console.error("Failed to fetch NTP time:", error);
            return null;
        }
    }

    /************************************************************
     *  Smooth Real-Time Clock Update (Higher Accuracy)
     ************************************************************/
    function updateClock() {
        const now = new Date(Date.now() + offset);

        // Convert UTC to user's local time
        const localTimeString = now.toLocaleTimeString("en-US", { 
            hour: "2-digit", 
            minute: "2-digit", 
            second: "2-digit", 
            hour12: true 
        });

        document.getElementById("clock").innerText = localTimeString;

        // Use requestAnimationFrame for smoother updates
        requestAnimationFrame(updateClock);
    }

    /************************************************************
     *  Continuous Sync: Re-sync every 2 minutes to avoid drift
     ************************************************************/
    setInterval(() => {
        const drift = Date.now() - lastSyncTime;
        if (drift > 120000) { // Re-sync if more than 2 minutes have passed
            syncTime();
        }
    }, 10000); // Check every 10 seconds

    /************************************************************
     *  Page Initialization
     ************************************************************/
    window.onload = async () => {
        await syncTime(5); // Perform 5 pings on startup
        updateClock(); // Start updating clock in real time
    };
</script>
</head>
<body>
  <h1>World Time USA</h1>
  <div id="clock">--:--:--</div>
  <p id="loading">Syncing with NTP server...</p>
</body>
</html>
