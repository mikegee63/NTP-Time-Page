<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Time USA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    h1 {
      font-size: 3em;
      margin-bottom: 10px;
    }
    #clock {
      font-size: 5em;
      font-weight: bold;
    }
    #loading {
      font-size: 1.5em;
      margin-top: 10px;
    }
  </style>
  <script>
    let offset = 0; // Final offset in ms between server & client

    /************************************************************
     *  Single Ping: Fetch offset once from /time
     ************************************************************/
    async function singleSyncTime() {
      try {
        const response = await fetch("/time");
        const data = await response.json();
        const serverTime = new Date(data.time).getTime();
        const clientTime = Date.now();
        return serverTime - clientTime; // offset for one ping
      } catch (error) {
        console.error("Failed to fetch NTP time:", error);
        return null; // indicates failure
      }
    }

    /************************************************************
     *  Multi-Ping Sync: do several pings, pick median offset
     ************************************************************/
    async function multiSyncTime(pings = 3) {
      const offsets = [];
      // Optional: show some "Syncing..." text
      document.getElementById("loading").textContent = "Syncing with NTP server...";

      for (let i = 0; i < pings; i++) {
        const singleOffset = await singleSyncTime();
        if (singleOffset !== null) {
          offsets.push(singleOffset);
        }
        // short pause between each ping (100 ms)
        await new Promise(res => setTimeout(res, 100));
      }

      if (offsets.length === 0) {
        console.error("All pings failed! Offset not updated.");
        document.getElementById("loading").textContent = "Sync failed.";
        return;
      }

      // Sort numeric offsets
      offsets.sort((a, b) => a - b);

      // Median
      const mid = Math.floor(offsets.length / 2);
      if (offsets.length % 2 === 1) {
        offset = offsets[mid];
      } else {
        offset = (offsets[mid - 1] + offsets[mid]) / 2;
      }

      // After multi-sync, we can update immediately
      updateClock();
      document.getElementById("loading").textContent = "Sync complete.";
      console.log(`Multi-sync offsets: ${offsets.map(o => o.toFixed(1))} ms, final offset: ${offset.toFixed(1)} ms`);
    }

    /************************************************************
     *  Clock Display (12-hour format)
     ************************************************************/
    function updateClock() {
      const now = new Date(Date.now() + offset);

      // Convert from 24-hour to 12-hour
      let hours = now.getHours(); // 0â€“23
      const minutes = String(now.getMinutes()).padStart(2, "0");
      const seconds = String(now.getSeconds()).padStart(2, "0");

      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) {
        hours = 12;
      }

      const hoursStr = String(hours).padStart(2, "0");
      document.getElementById("clock").innerText =
        `${hoursStr}:${minutes}:${seconds} ${ampm}`;
    }

    /************************************************************
     *  Page Initialization
     ************************************************************/
    window.onload = () => {
      // 1) Perform multi-ping (3 pings) on page load
      multiSyncTime(3);
      // 2) Start updating the clock every second
      setInterval(updateClock, 1000);
    };
  </script>
</head>
<body>
  <h1>World Time USA</h1>
  <div id="clock">--:--:--</div>
  <p id="loading">Syncing with NTP server...</p>
</body>
</html>
